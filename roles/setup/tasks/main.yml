---
- name: "Create User"
  user:
    name: "{{ user }}"
    shell: /bin/bash
- ansible.builtin.user:
    user: "{{ user }}"
    group: "{{ user }}"
- authorized_key:
    user: "{{ user }}"
    key: "{{ lookup ('file', '~/.ssh/id_rsa.pub') }}"
    state: present

- name: Update & Upgrade System Dependencies
  apt:
    upgrade: dist
    update_cache: yes

- name: Change Hostname
  template:
    src: hostname.j2
    dest: "/etc/hostname"
  register: hostname_changed

- name: Check domain is set in /etc/hosts
  shell: grep -q "{{ domain }}" /etc/hosts
  register: hosts_is_registered
  ignore_errors: true

- name: Setup Hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '^127＼.0＼.1＼.1'
    line: "127.0.1.1 {{ domain }} {{ domain_name }}"

- name: Reboot Server
  reboot:
  become: true
  when: hostname_changed.changed


